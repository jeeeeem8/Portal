<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Leave Request Form</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      margin: 0;
      background-image: url(infobg.png);
      background-size: cover;
      color: #111;
    }
    .wrap {
      max-width: 520px;
      margin: 36px auto;
      padding: 24px;
    }
    .container {
      background: white;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
      max-width: 480px;
      margin-left: 725px;
      width: 100%;
      box-sizing: border-box;
    }
    h2 {
      color: #2563eb;
      font-weight: 700;
      margin-bottom: 25px;
      text-align: center;
      font-size: 28px;
      letter-spacing: 0.03em;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 15px;
      color: #1e293b;
    }
    input[type="text"],
    select,
    input[type="date"],
    textarea {
      width: 100%;
      padding: 10px 14px;
      margin-bottom: 20px;
      border: 1.5px solid #cbd5e1;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.25s;
      font-family: 'Inter', sans-serif;
      box-sizing: border-box;
    }
    input[type="text"]:focus,
    select:focus,
    input[type="date"]:focus,
    textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 6px rgba(37, 99, 235, 0.3);
    }
    textarea {
      resize: vertical;
      min-height: 90px;
      font-family: 'Inter', sans-serif;
    }
    button {
      background-color: #2563eb;
      border: none;
      color: white;
      font-weight: 600;
      font-size: 16px;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.25s;
      margin-top: 10px;
    }
    button:hover {
      background-color: #1e40af;
    }
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 10px;
    }
    .button-group button {
      flex: 1;
      width: auto;
    }
    #message {
      margin-top: 15px;
      font-weight: 600;
      color: #ef4444; /* red */
      text-align: center;
      min-height: 24px;
      font-size: 15px;
      user-select: none;
    }
  </style>
</head>
<body>
  <br><br>
  <div class="container">
    <h2>Leave Request Form</h2>

    <form id="leaveForm" novalidate>
      <label for="employeeName">Employee Name:</label>
      <input type="text" id="employeeName" name="employeeName" required autocomplete="name" placeholder="Enter your full name" />

      <input type="hidden" id="role" value="Employee" />

      <label for="leaveType">Leave Type:</label>
      <select id="leaveType" name="leaveType" required>
        <option value="" disabled selected>Select type</option>
        <option value="Sick Leave">Sick Leave</option>
        <option value="Vacation Leave">Vacation Leave</option>
        <option value="Emergency Leave">Emergency Leave</option>
        <option value="Others">Others</option>
      </select>

      <label for="startDate">Start Date:</label>
      <input type="date" id="startDate" name="startDate" required />

      <label for="endDate">End Date:</label>
      <input type="date" id="endDate" name="endDate" required />

      <label for="reason">Reason:</label>
      <textarea id="reason" name="reason" rows="4" required placeholder="Enter reason for leave"></textarea>

      <div class="button-group">
        <button type="submit">Submit Request</button>
        <button type="button" id="statusBtn">Request Status</button>
        <button type="button" id="backBtn">Back</button>
      </div>
    </form>

    <div id="message" aria-live="polite"></div>
  </div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB1Gbmp2j2cTfnUmuWTjcL2ypauUpQn8Qc",
      authDomain: "jahsportal.firebaseapp.com",
      databaseURL: "https://jahsportal-default-rtdb.firebaseio.com",
      projectId: "jahsportal",
      storageBucket: "jahsportal.firebasestorage.app",
      messagingSenderId: "798312139932",
      appId: "1:798312139932:web:2f6654cdd82a23406ff159"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const loggedRole = localStorage.getItem("role");

    function showWarningAndRedirect(title, text, redirectUrl) {
      Swal.fire({
        icon: "warning",
        title: title,
        text: text,
        confirmButtonColor: "#2563eb"
      }).then(() => {
        window.location.href = redirectUrl;
      });
    }

    if (!["teamleader", "employee"].includes(loggedRole)) {
      showWarningAndRedirect("Access denied.", "You do not have permission to view this page.", "index.html");
    } else {
      document.getElementById("role").value = loggedRole;
    }

    // Back button handler
    document.getElementById("backBtn").addEventListener("click", () => {
      if (window.history.length > 1) {
        window.history.back();
        setTimeout(() => {
          if (document.location.href.indexOf("request") !== -1) {
            window.location.href = "index.html";
          }
        }, 500);
      } else {
        window.location.href = "index.html";
      }
    });

    // Request Status button handler
    document.getElementById("statusBtn").addEventListener("click", () => {
      window.location.href = "request_status.html";
    });

    // Set minimum dates for date inputs
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("startDate").setAttribute("min", today);
    document.getElementById("endDate").setAttribute("min", today);

    // Handle form submission
    document.getElementById("leaveForm").addEventListener("submit", (e) => {
      e.preventDefault();

      const name = document.getElementById("employeeName").value.trim();
      const role = document.getElementById("role").value;
      const type = document.getElementById("leaveType").value;
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      const reason = document.getElementById("reason").value.trim();

      if (new Date(start) > new Date(end)) {
        document.getElementById("message").textContent = "Error: Start date cannot be after end date.";
        return;
      }

      const leaveData = {
        name,
        role,
        type,
        startDate: start,
        endDate: end,
        reason,
        status: "Pending",
        timestamp: new Date().toISOString()
      };

      db.ref("leaveRequests").push(leaveData)
        .then(() => {
          document.getElementById("message").textContent = "Leave request submitted successfully!";
          document.getElementById("leaveForm").reset();
          document.getElementById("startDate").setAttribute("min", today);
          document.getElementById("endDate").setAttribute("min", today);
        })
        .catch((error) => {
          document.getElementById("message").textContent = "Error: " + error.message;
        });
    });
  </script>
</body>
</html>
