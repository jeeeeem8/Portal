<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>  
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>  
  <title>JAHS Admin Dashboard - Deployment Logs</title>

  <!-- Bootstrap 5 -->  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>  

  <!-- Lordicon -->  
  <script src="https://cdn.lordicon.com/lordicon.js"></script>  

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #e4e7f6, #f4f6fc);
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background: linear-gradient(180deg, #2f3b8f, #1d2b64);  
      color: #fff;
      padding-top: 60px;
      box-shadow: 2px 0 15px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
    }

    .sidebar a {
      color: #fff;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      text-decoration: none;
      transition: all 0.3s ease;
      font-size: .93rem;
    }

    .sidebar a:hover {
      background: rgba(255,255,255,0.2);
      transform: translateX(10px) scale(1.05);
      border-radius: 8px;
    }

    .sidebar lord-icon {
      width: 28px;
      height: 28px;
      margin-right: 12px;
      filter: brightness(0) invert(1);
      transition: transform 0.4s ease;
    }

    .sidebar a:hover lord-icon {
      transform: rotate(15deg) scale(1.3);
    }

    /* Navbar */
    .navbar {
      margin-left: 250px;
      transition: all 0.3s ease;
      z-index: 10;
    }

    /* Main content */
    .content {
      margin-left: 250px;
      margin-top: 56px; /* Navbar height */
      height: calc(100vh - 56px);
      padding: 15px;
      display: flex;
      flex-direction: column;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .table-container {
      flex: 1;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #364fc7;
      color: #fff;
      cursor: pointer;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    td, th {
      padding: 8px;
      text-align: left;
      vertical-align: middle;
      border: 1px solid #dee2e6;
    }

    @media print {
      body * { visibility: hidden !important; }
      #printArea, #printArea * { visibility: visible !important; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <img src="jahslogo.png" style="height: 100px; margin-left: 20px" alt="logo">
    <a href="admin_dashboard.html">
      <lord-icon src="https://cdn.lordicon.com/osuxyevn.json" trigger="hover"></lord-icon>
      Dashboard
    </a>
    <a href="deployment.html">
      <lord-icon src="https://cdn.lordicon.com/abwrkdvl.json" trigger="hover"></lord-icon>
      Deployment
    </a>
    <a href="inventory.html">
      <lord-icon src="https://cdn.lordicon.com/hwuyodym.json" trigger="hover"></lord-icon>
      Inventory
    </a>
    <a href="salary.html">
      <lord-icon src="https://cdn.lordicon.com/qhgmphtg.json" trigger="hover"></lord-icon>
      Payroll
    </a>
    <a href="Announcement.html">
      <lord-icon src="https://cdn.lordicon.com/hpivxauj.json" trigger="hover"></lord-icon>
      Announcement
    </a>
    <a href="Manage_account_dashboard.html">
      <lord-icon src="https://cdn.lordicon.com/dklbhvrt.json" trigger="hover"></lord-icon>
      Manage Accounts
    </a>
    <a href="#">--------- History Logs --------</a>

    <a href="deployment_log.html">
      <lord-icon src="https://cdn.lordicon.com/abwrkdvl.json" trigger="hover"></lord-icon>
      Deployment History Log
    </a>

    <a href="inventory_log.html">
      <lord-icon src="https://cdn.lordicon.com/hwuyodym.json" trigger="hover"></lord-icon>
      Inventory History Log
    </a>

    <a href="salary_logs.html">
      <lord-icon src="https://cdn.lordicon.com/qhgmphtg.json" trigger="hover"></lord-icon>
      Salary History Log
    </a>

    <a href="Reports.html">
      <lord-icon src="https://cdn.lordicon.com/wloilxuq.json" trigger="hover"></lord-icon>
      Report History Log
    </a>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand ms-3 fw-bold" href="#">JAHS Telecon Employee Web Portal</a>
      <div class="dropdown ms-auto me-3">
        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
          <lord-icon src="https://cdn.lordicon.com/ajkxzzfb.json" trigger="hover" style="width:28px;height:28px;margin-right:8px;"></lord-icon>
          <span id="welcome">Loading...</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end">

          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="#" onclick="logout()">Log out</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="content">
    <h2 class="mb-3">Deployment Logs</h2>

    <!-- Filters -->
    <div class="filter-row">
      <input type="text" id="searchInput" class="form-control w-auto" placeholder="Search deployments..." oninput="applyFilters()"/>
      <select id="acceptedFilter" class="form-select w-auto" onchange="applyFilters()">
        <option value="">All Accepted Status</option>
        <option value="true">Accepted</option>
        <option value="false">Not Accepted</option>
      </select>
      <select id="teamLeaderFilter" class="form-select w-auto" onchange="applyFilters()">
        <option value="">All Team Leaders</option>
      </select>
      <button class="btn btn-primary ms-2" onclick="printSelected()">Print Selected</button>
      <button class="btn btn-success ms-2" onclick="downloadSelected()">Download Selected</button>

    </div>

    <!-- Table -->
    <div class="table-container">
      <table class="table table-bordered table-striped" id="deploymentTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"/></th>
            <th onclick="sortTable('accepted')">Accepted</th>
            <th onclick="sortTable('acceptedAt')">Accepted At</th>
            <th onclick="sortTable('completed')">Completed</th>
            <th onclick="sortTable('completedAt')">Completed At</th>
            <th onclick="sortTable('deploymentDays', true)">Deployment Days</th>
            <th onclick="sortTable('employees')">Employees</th>
            <th onclick="sortTable('location')">Location</th>
            <th onclick="sortTable('startDate')">Start Date</th>
            <th onclick="sortTable('endDate')">End Date</th>
            <th onclick="sortTable('teamLeader')">Team Leader</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="11" class="text-center">Loading deployments...</td></tr>
        </tbody>
      </table>
    </div>

    <div id="printArea" style="display:none;"></div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB1Gbmp2j2cTfnUmuWTjcL2ypauUpQn8Qc",
      authDomain: "jahsportal.firebaseapp.com",
      databaseURL: "https://jahsportal-default-rtdb.firebaseio.com",
      projectId: "jahsportal",
      storageBucket: "jahsportal.firebasestorage.app",
      messagingSenderId: "798312139932",
      appId: "1:798312139932:web:2f6654cdd82a23406ff159"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const userName = localStorage.getItem("userName") || "Guest";
    const role = localStorage.getItem("role") || "visitor";
    document.getElementById("welcome").innerHTML = `Welcome, ${userName} (${role})`;

    let allDeployments = [];
    let sortState = { column: "acceptedAt", desc: true };

    function renderDeployments() {
  const tbody = document.querySelector("#deploymentTable tbody");
  db.ref("deployments").on("value", snapshot => {
    const data = snapshot.val();
    if (!data) {
      tbody.innerHTML = '<tr><td colspan="11" class="text-center">No deployments found.</td></tr>';
      return;
    }
    
    allDeployments = Object.entries(data).map(([key, dep]) => {
      // Calculate inclusive deployment days
      let days = 0;
      if (dep.startDate && dep.endDate) {
        const start = new Date(dep.startDate);
        const end = new Date(dep.endDate);
        days = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
      }
      return {
        __key: key,
        accepted: dep.accepted ?? false,
        acceptedAt: dep.acceptedAt ?? "",
        completed: dep.completed ?? false,
        completedAt: dep.completedAt ?? "",
        deploymentDays: days,
        employees: Array.isArray(dep.employees) ? dep.employees.join(", ") : "",
        location: dep.location ?? "",
        startDate: dep.startDate ?? "",
        endDate: dep.endDate ?? "",
        teamLeader: dep.teamLeader ?? "",
      };
    });
    populateTeamLeaderFilter();
    applyFilters();
  }, error => {
    Swal.fire("Error", `Error loading deployments: ${error.message}`, "error");
  });
}


    function populateTeamLeaderFilter() {
      const leaders = new Set(allDeployments.map(d => d.teamLeader).filter(Boolean));
      const filter = document.getElementById("teamLeaderFilter");
      filter.innerHTML = `<option value="">All Team Leaders</option>` +
        Array.from(leaders).sort().map(leader => `<option value="${leader}">${leader}</option>`).join('');
    }

    function applyFilters() {
      let deployments = allDeployments.slice();
      const acceptedFilter = document.getElementById("acceptedFilter").value;
      const leaderFilter = document.getElementById("teamLeaderFilter").value;
      const search = document.getElementById("searchInput").value.trim().toLowerCase();

      if (acceptedFilter === "true") deployments = deployments.filter(d => d.accepted === true);
      if (acceptedFilter === "false") deployments = deployments.filter(d => d.accepted === false);
      if (leaderFilter) deployments = deployments.filter(d => d.teamLeader === leaderFilter);
      if (search) {
        deployments = deployments.filter(d =>
          (d.acceptedAt.toLowerCase().includes(search)) ||
          (d.completedAt.toLowerCase().includes(search)) ||
          d.location.toLowerCase().includes(search) ||
          d.employees.toLowerCase().includes(search) ||
          d.teamLeader.toLowerCase().includes(search) ||
          d.startDate.toLowerCase().includes(search) ||
          d.endDate.toLowerCase().includes(search) ||
          String(d.deploymentDays).includes(search) ||
          String(d.accepted).toLowerCase().includes(search) ||
          String(d.completed).toLowerCase().includes(search)
        );
      }

      deployments = sortDeployments(deployments, sortState.column, sortState.desc);
      displayDeployments(deployments);
    }

    function sortTable(column) {
      if (sortState.column === column) sortState.desc = !sortState.desc;
      else { sortState.column = column; sortState.desc = true; }
      applyFilters();
    }

    function sortDeployments(data, column, desc = true) {
      return data.slice().sort((a, b) => {
        let valA = a[column], valB = b[column];
        if (column === 'deploymentDays') { valA = Number(valA) || 0; valB = Number(valB) || 0; }
        else if (['acceptedAt','completedAt','startDate','endDate'].includes(column)) {
          valA = valA ? new Date(valA).getTime() : 0;
          valB = valB ? new Date(valB).getTime() : 0;
        } 
        else if (typeof valA === "string" && typeof valB === "string") {
          const cmp = valA.localeCompare(valB, undefined, { numeric: true });
          return desc ? -cmp : cmp;
        }
        else { valA = valA==null?'':valA; valB = valB==null?'':valB; return desc ? valB-valA : valA-valB; }
        return desc ? valB - valA : valA - valB;
      });
    }

    function displayDeployments(deployments) {
      const tbody = document.querySelector("#deploymentTable tbody");
      if (deployments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center">No deployments match your filter.</td></tr>';
        return;
      }
      tbody.innerHTML = deployments.map(d => `
        <tr>
          <td><input type="checkbox" class="rowCheckbox" value="${d.__key}"/></td>
          <td>${d.accepted ? 'Yes' : 'No'}</td>
          <td>${d.acceptedAt || '-'}</td>
          <td>${d.completed ? 'Yes' : 'No'}</td>
          <td>${d.completedAt || '-'}</td>
          <td>${d.deploymentDays}</td>
          <td>${d.employees || '-'}</td>
          <td>${d.location || '-'}</td>
          <td>${d.startDate || '-'}</td>
          <td>${d.endDate || '-'}</td>
          <td>${d.teamLeader || '-'}</td>
        </tr>
      `).join('');
      document.getElementById("selectAll").checked = false;
    }

    function toggleSelectAll(box) { document.querySelectorAll('.rowCheckbox').forEach(cb => cb.checked = box.checked); }

    function printSelected() {
      const checkboxes = document.querySelectorAll('.rowCheckbox:checked');
      if(checkboxes.length===0){ 
        Swal.fire("No Selection", "Please select at least one deployment to print.", "warning"); 
        return; 
      }
      const selectedKeys = Array.from(checkboxes).map(cb=>cb.value);
      const selectedDeployments = allDeployments.filter(d=>selectedKeys.includes(d.__key));
      const printHTML = `<h2>Selected Deployment Logs</h2>
        <table class="table table-bordered table-striped">
          <thead><tr>
            <th>Accepted</th><th>Accepted At</th><th>Completed</th><th>Completed At</th>
            <th>Deployment Days</th><th>Employees</th><th>Location</th>
            <th>Start Date</th><th>End Date</th><th>Team Leader</th>
          </tr></thead>
          <tbody>
            ${selectedDeployments.map(d=>`<tr>
              <td>${d.accepted?'Yes':'No'}</td>
              <td>${d.acceptedAt||'-'}</td>
              <td>${d.completed?'Yes':'No'}</td>
              <td>${d.completedAt||'-'}</td>
              <td>${d.deploymentDays}</td>
              <td>${d.employees||'-'}</td>
              <td>${d.location||'-'}</td>
              <td>${d.startDate||'-'}</td>
              <td>${d.endDate||'-'}</td>
              <td>${d.teamLeader||'-'}</td>
            </tr>`).join('')}
          </tbody>
        </table>`;
      const printArea = document.getElementById('printArea');
      printArea.innerHTML = printHTML;
      printArea.style.display='block';
      window.print();
      printArea.style.display='none';
    }

    function logout() {  
      Swal.fire({  
        title: "Are you sure?",  
        text: "You will be logged out of the system.",  
        icon: "warning",  
        showCancelButton: true,  
        confirmButtonColor: "#2f3b8f",  
        cancelButtonColor: "#d33",  
        confirmButtonText: "Yes, log out"  
      }).then((result) => {  
        if (result.isConfirmed) {  
          localStorage.clear();  
          Swal.fire({  
            title: "Logged out!",  
            text: "Redirecting to welcome page...",  
            icon: "success",  
            timer: 1500,  
            showConfirmButton: false  
          });  
          setTimeout(() => {  
            window.location.href = "welcome_page.html";  
          }, 1500);  
        }  
      });  
    }  


    window.onload = renderDeployments;

    
  </script>

<!-- SheetJS (XLSX library) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>

<script>
function downloadSelected() {
  const checkboxes = document.querySelectorAll('.rowCheckbox:checked');
  if (checkboxes.length === 0) {
    Swal.fire("No Selection", "Please select at least one deployment to download.", "warning");
    return;
  }

  // Get table headers from visible table
  const headers = Array.from(document.querySelectorAll("table thead th"))
    .slice(1) // remove the checkbox column
    .map(th => th.textContent.trim());

  // Collect selected rows
  const rows = Array.from(checkboxes).map(cb => {
    const row = cb.closest("tr");
    const cells = Array.from(row.querySelectorAll("td"))
      .slice(1) // remove checkbox cell
      .map(td => td.textContent.trim());
    return cells;
  });

  // Convert data into Excel sheet
  const wsData = [headers, ...rows];
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Deployment Logs");

  // Auto-adjust column width
  const colWidths = headers.map((_, i) => ({
    wch: Math.max(...rows.map(r => (r[i] ? r[i].length : 0)), headers[i].length) + 2
  }));
  ws['!cols'] = colWidths;

  // Download the file
  const date = new Date().toISOString().split("T")[0];
  XLSX.writeFile(wb, `Deployment_Logs_${date}.xlsx`);

  Swal.fire("Download Ready", "The selected deployment logs have been downloaded.", "success");
}
</script>

</body>
</html>
