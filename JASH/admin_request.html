<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JAHS Admin Dashboard - Leave Management</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Lordicon -->
  <script src="https://cdn.lordicon.com/lordicon.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #e4e7f6, #f4f6fc);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    .sidebar {
      width: 250px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background: linear-gradient(180deg, #2f3b8f, #1d2b64);
      color: #fff;
      padding-top: 60px;
      box-shadow: 2px 0 15px rgba(0,0,0,0.2);
    }
    .sidebar img { height: 100px; margin-left: 20px; margin-bottom: 20px; }
    .sidebar a {
      color: #fff;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      text-decoration: none;
      transition: all 0.3s ease;
      font-size: .93rem;
    }
    .sidebar a:hover {
      background: rgba(255,255,255,0.2);
      transform: translateX(10px) scale(1.05);
      border-radius: 8px;
    }
    .sidebar lord-icon {
      width: 28px;
      height: 28px;
      margin-right: 12px;
      filter: brightness(0) invert(1);
      transition: transform 0.4s ease;
    }
    .sidebar a:hover lord-icon { transform: rotate(15deg) scale(1.3); }

    .navbar {
      margin-left: 250px;
      transition: all 0.3s ease;
    }

    .content {
      margin-left: 250px;
      padding: 20px;
      height: calc(100vh - 56px);
      overflow-y: auto;
    }

    h2 {
      color: #2563eb;
      margin-bottom: 15px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    #controls {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    #searchBox {
      flex-grow: 1;
      padding: 10px 12px;
      font-size: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
      min-width: 250px;
      font-weight: 400;
    }

    button {
      padding: 10px 18px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      color: white;
      background-color: #2563eb;
      transition: background-color 0.3s ease;
      flex-shrink: 0;
      font-size: 15px;
      letter-spacing: 0.02em;
      user-select: none;
    }
    button:hover { background-color: #1e40af; }
    #deleteSelectedBtn { background-color: #c0392b; }
    #deleteSelectedBtn:hover { background-color: #981f1f; }
    #backBtn {
      background-color: #555;
      width: 100px;
      font-weight: 600;
      margin-top: 20px;
    }
    #backBtn:hover { background-color: #333; }

    #leaveList {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .leave-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.07);
      display: flex;
      flex-direction: row;
      gap: 15px;
      align-items: flex-start;
      position: relative;
    }

    .checkbox-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-right: 15px;
      flex-shrink: 0;
    }

    .checkbox-container input[type="checkbox"] {
      margin-bottom: 10px;
      transform: scale(1.3);
      cursor: pointer;
    }

    .card-content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-header {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 1.1em;
    }

    .leave-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      font-size: 14px;
      font-weight: 600;
    }

    .reason {
      margin-top: 10px;
      font-style: italic;
      color: #555;
      font-weight: 400;
      font-size: 14px;
    }

    .status {
      font-weight: 700;
      text-transform: uppercase;
      margin-left: auto;
      font-size: 0.9em;
      font-family: 'Inter', sans-serif;
    }

    .approved { color: green; }
    .rejected { color: red; }
    .pending { color: orange; }

    .actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }

    .actions button {
      flex: 0 0 auto;
      padding: 6px 12px;
      font-weight: 600;
      border-radius: 6px;
      color: white;
      border: none;
      transition: background-color 0.3s ease;
      font-size: 14px;
      letter-spacing: 0.02em;
      user-select: none;
    }

    .approve-btn { background-color: #22c55e; }
    .approve-btn:hover { background-color: #16a34a; }
    .reject-btn { background-color: #ef4444; }
    .reject-btn:hover { background-color: #b91c1c; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <img src="jahslogo.png" alt="logo">
    <a href="admin_dashboard.html"><lord-icon src="https://cdn.lordicon.com/osuxyevn.json" trigger="hover"></lord-icon>Dashboard</a>
    <a href="deployment.html"><lord-icon src="https://cdn.lordicon.com/abwrkdvl.json" trigger="hover"></lord-icon>Deployment</a>
    <a href="inventory.html"><lord-icon src="https://cdn.lordicon.com/hwuyodym.json" trigger="hover"></lord-icon>Inventory</a>
    <a href="salary.html"><lord-icon src="https://cdn.lordicon.com/qhgmphtg.json" trigger="hover"></lord-icon>Payroll</a>
    <a href="Announcement.html"><lord-icon src="https://cdn.lordicon.com/hpivxauj.json" trigger="hover"></lord-icon>Announcement</a>
    <a href="Manage_account_dashboard.html"><lord-icon src="https://cdn.lordicon.com/dklbhvrt.json" trigger="hover"></lord-icon>Manage Accounts</a>
    <a href="#">--------- History Logs --------</a>
    <a href="deployment_log.html"><lord-icon src="https://cdn.lordicon.com/abwrkdvl.json" trigger="hover"></lord-icon>Deployment History Log</a>
    <a href="inventory_log.html"><lord-icon src="https://cdn.lordicon.com/hwuyodym.json" trigger="hover"></lord-icon>Inventory History Log</a>
    <a href="salary_logs.html"><lord-icon src="https://cdn.lordicon.com/qhgmphtg.json" trigger="hover"></lord-icon>Salary History Log</a>
    <a href="Reports.html"><lord-icon src="https://cdn.lordicon.com/wloilxuq.json" trigger="hover"></lord-icon>Report History Log</a>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand ms-3 fw-bold" href="#">JAHS Telecon Employee Web Portal</a>
      <div class="dropdown ms-auto me-3">
        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
          <lord-icon src="https://cdn.lordicon.com/ajkxzzfb.json" trigger="hover" style="width:28px;height:28px;margin-right:8px;"></lord-icon>
          <span id="welcome">Welcome, Guest</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="#" onclick="logout()">Log out</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <br><br><br>
  <div class="content">
    <h2>Employee Leave Management</h2>
    <div id="controls">
      <button id="backBtn">Back</button>
      <input type="text" id="searchBox" placeholder="Search by Employee Name or Role" />
      <button id="deleteSelectedBtn">Delete Selected</button>
    </div>
    <div id="leaveList"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Logout
    function logout() {
      Swal.fire({
        title: 'Are you sure?',
        text: "You will be logged out.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#2f3b8f',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, log out'
      }).then((result) => {
        if(result.isConfirmed){
          localStorage.clear();
          Swal.fire({title:'Logged out!', icon:'success', timer:1500, showConfirmButton:false});
          setTimeout(()=>{ window.location.href = "welcome_page.html"; }, 1500);
        }
      });
    }

    // Display username
    const userName = localStorage.getItem("userName") || "Guest";
    const role = localStorage.getItem("role") || "Visitor";
    document.getElementById("welcome").innerText = `Welcome, ${userName} (${role})`;

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyB1Gbmp2j2cTfnUmuWTjcL2ypauUpQn8Qc",
      authDomain: "jahsportal.firebaseapp.com",
      databaseURL: "https://jahsportal-default-rtdb.firebaseio.com",
      projectId: "jahsportal",
      storageBucket: "jahsportal.firebasestorage.app",
      messagingSenderId: "798312139932",
      appId: "1:798312139932:web:2f6654cdd82a23406ff159"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const leaveList = document.getElementById('leaveList');
    const searchBox = document.getElementById('searchBox');
    const backBtn = document.getElementById('backBtn');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    let leaveRequestsCache = [];

    function createLeaveCard({ key, data }) {
      const card = document.createElement('article');
      card.className = 'leave-card';
      card.innerHTML = `
        <div class="checkbox-container">
          <input type="checkbox" class="selectBox" data-key="${key}">
        </div>
        <div class="card-content">
          <div class="card-header">
            <strong>${data.name}</strong>
            <div class="status ${data.status.toLowerCase()}">${data.status}</div>
          </div>
          <div class="leave-info">
            <div><strong>Leave Type</strong><br>${data.type}</div>
            <div><strong>Start Date</strong><br>${data.startDate}</div>
            <div><strong>End Date</strong><br>${data.endDate}</div>
          </div>
          <div class="reason">Reason: ${data.reason}</div>
          <div class="actions">
            <button class="approve-btn">Approve</button>
            <button class="reject-btn">Reject</button>
          </div>
        </div>`;
      card.querySelector('.approve-btn').addEventListener('click', () => updateStatus(key, 'Approved'));
      card.querySelector('.reject-btn').addEventListener('click', () => updateStatus(key, 'Rejected'));
      return card;
    }

    function renderLeaveRequests(requests) {
      leaveList.innerHTML = '';
      if (requests.length === 0) {
        leaveList.innerHTML = '<p>No matching leave requests found.</p>';
        return;
      }
      requests.slice().reverse().forEach(req => leaveList.appendChild(createLeaveCard(req)));
    }

    function loadLeaveRequests() {
      db.ref("leaveRequests").once("value").then(snapshot => {
        leaveRequestsCache = [];
        snapshot.forEach(child => leaveRequestsCache.push({ key: child.key, data: child.val() }));
        renderLeaveRequests(leaveRequestsCache);
      });
    }

    function updateStatus(key, newStatus) {
      Swal.fire({
        title: `Confirm ${newStatus}?`,
        text: `Are you sure you want to mark this request as ${newStatus}?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: `Yes, ${newStatus}`,
        confirmButtonColor: newStatus === 'Approved' ? '#22c55e' : '#ef4444'
      }).then(result => {
        if (result.isConfirmed) {
          db.ref("leaveRequests/" + key).update({ status: newStatus })
            .then(() => {
              Swal.fire('Success!', `Leave request ${newStatus.toLowerCase()} successfully!`, 'success');
              const index = leaveRequestsCache.findIndex(r => r.key === key);
              if (index !== -1) {
                leaveRequestsCache[index].data.status = newStatus;
                filterRequests();
              }
            })
            .catch(error => Swal.fire('Error!', error.message, 'error'));
        }
      });
    }

    function filterRequests() {
      const query = searchBox.value.trim().toLowerCase();
      if (!query) return renderLeaveRequests(leaveRequestsCache);
      const filtered = leaveRequestsCache.filter(({ data }) =>
        data.name.toLowerCase().includes(query) ||
        (data.role && data.role.toLowerCase().includes(query))
      );
      renderLeaveRequests(filtered);
    }

    backBtn.addEventListener('click', () => {
      if (window.history.length > 1) window.history.back();
      else window.location.href = 'index.html';
    });

    searchBox.addEventListener('input', filterRequests);

    deleteSelectedBtn.addEventListener('click', () => {
      const selectedBoxes = [...document.querySelectorAll('.selectBox:checked')];
      if (selectedBoxes.length === 0) {
        Swal.fire('Notice', 'Please select at least one leave request to delete.', 'info');
        return;
      }

      Swal.fire({
        title: 'Confirm Deletion',
        text: `Delete ${selectedBoxes.length} selected leave request(s)? This action cannot be undone.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete',
        confirmButtonColor: '#c0392b'
      }).then(result => {
        if (result.isConfirmed) {
          const promises = selectedBoxes.map(box => db.ref("leaveRequests/" + box.dataset.key).remove());
          Promise.all(promises)
            .then(() => {
              Swal.fire('Deleted!', 'Selected leave requests deleted successfully!', 'success');
              loadLeaveRequests();
            })
            .catch(err => Swal.fire('Error!', err.message, 'error'));
        }
      });
    });

    window.onload = loadLeaveRequests;
  </script>
</body>
</html>
