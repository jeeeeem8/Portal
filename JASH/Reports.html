<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">  
  <title>JAHS Admin Dashboard - Deployment Reports</title>
  <!-- Bootstrap 5 -->  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Lordicon -->  
  <script src="https://cdn.lordicon.com/lordicon.js"></script>
  <!-- MapLibre GL CSS -->
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #eef2ff, #f8f9fc);
      overflow: hidden;
      margin: 0;
      color: #2c3e50;
    }
    .sidebar {
      width: 250px;
      height: 100vh;
      position: fixed;
      top: 0; left: 0;
      background: linear-gradient(180deg, #2f3b8f, #1d2b64);
      color: #fff;
      padding-top: 60px;
      box-shadow: 2px 0 15px rgba(0,0,0,0.2);
      z-index: 10;
    }
    .sidebar a {
      color: #fff;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      text-decoration: none;
      transition: all 0.3s ease;
      font-size: .93rem;
    }
    .sidebar a:hover {
      background: rgba(255,255,255,0.2);
      transform: translateX(10px) scale(1.05);
      border-radius: 8px;
    }
    .sidebar lord-icon {
      width: 28px;
      height: 28px;
      margin-right: 12px;
      filter: brightness(0) invert(1);
      transition: transform 0.4s ease;
    }
    .sidebar a:hover lord-icon {
      transform: rotate(15deg) scale(1.3);
    }
    .navbar {
      margin-left: 250px;
      transition: all 0.3s ease;
      background: #ffffffcc;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }
    .content {
      margin-left: 250px;
      margin-top: 70px;
      height: calc(100vh - 70px);
      overflow-y: auto;
      padding: 20px 40px;
    }
    .report {
      background: #fff;
      border-radius: 16px;
      padding: 20px 25px;
      margin-bottom: 25px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid #e0e3ff;
      position: relative;
      max-width: 100%;
      max-height: 420px;
      overflow: auto;
      min-width: 290px;
    }
    .report:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.12);
    }
    .report strong { color: #1a237e; }
    .delete-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background-color: #ff5252;
      border: none;
      color: white;
      border-radius: 8px;
      padding: 5px 10px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    .delete-btn:hover { background-color: #d32f2f; }
    .map {
      width: 100%;
      height: 250px;
      margin-top: 12px;
      border-radius: 12px;
      overflow: hidden;
    }
    .images {
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      overflow-x: auto;
      white-space: nowrap;
      max-width: 100%;
    }
    .images img {
      max-width: 130px;
      max-height: 130px;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid #d1d9ff;
      transition: transform 0.3s ease;
      display: inline-block;
      margin-right: 6px;
    }
    .images img:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    #printBtn {
      margin-bottom: 20px;
      border-radius: 10px;
      font-weight: 600;
      box-shadow: 0 5px 15px rgba(63,81,181,0.25);
    }
    .select-label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-weight: bold;
      color: #2c3e50;
    }
    #searchInput {
      padding: 10px 15px;
      width: 100%;
      max-width: 400px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
    }
    @media print {
      body, html {
        background: #fff !important;
        color: #000 !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      .sidebar, .navbar, .btn, .delete-btn, .form-check, input[type="checkbox"], .select-label, .img-clickable, .maplibregl-canvas, #selectAllReports, #printBtn, #searchInput, .btn-group {
        display: none !important;
        visibility: hidden !important;
        height: 0 !important;
        width: 0 !important;
      }
      .content {
        margin: 0 !important;
        padding: 0.2in !important;
      }
      #reportsContainer, .report {
        box-shadow: none !important;
        border-radius: 0 !important;
        margin: 0 !important;
        padding: 0.15in !important;
        background: #fff !important;
        width: 100% !important;
        min-width: 0 !important;
        max-width: 100% !important;
        overflow: visible !important;
      }
      .report {
        border: none !important;
        margin-bottom: 0.22in !important;
        page-break-inside: avoid !important;
        max-height: none !important;
        overflow: visible !important;
      }
      .report strong, .report span {
        color: #222 !important;
        font-weight: bold !important;
      }
      img {
        max-width: 4in !important;
        height: auto !important;
        page-break-inside: avoid !important;
      }
      p, label, span, strong, div {
        font-size: 12pt !important;
        color: #000 !important;
        background: none !important;
        text-align: left !important;
        line-height: 1.4 !important;
        margin: 0 0 6px 0 !important;
        padding: 0 !important;
      }
      h1, h2, h3, h4 {
        color: #111 !important;
        padding-bottom: 0.06in !important;
        margin-bottom: 0.06in !important;
        font-weight: bold !important;
      }
      .modal, .modal-backdrop, #imageModal, .footer, header, .maplibregl-canvas {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <img src="jahslogo.png" style="height: 100px; margin-left: 20px" alt="logo">
    <a href="admin_dashboard.html"><lord-icon src="https://cdn.lordicon.com/osuxyevn.json" trigger="hover"></lord-icon>Dashboard</a>
    <a href="deployment.html"><lord-icon src="https://cdn.lordicon.com/abwrkdvl.json" trigger="hover"></lord-icon>Deployment</a>
    <a href="inventory.html"><lord-icon src="https://cdn.lordicon.com/hwuyodym.json" trigger="hover"></lord-icon>Inventory</a>
    <a href="salary.html"><lord-icon src="https://cdn.lordicon.com/qhgmphtg.json" trigger="hover"></lord-icon>Payroll</a>
    <a href="Announcement.html"><lord-icon src="https://cdn.lordicon.com/hpivxauj.json" trigger="hover"></lord-icon>Announcement</a>
    <a href="Manage_account_dashboard.html"><lord-icon src="https://cdn.lordicon.com/dklbhvrt.json" trigger="hover"></lord-icon>Manage Accounts</a>
    <a href="#">--------- History Logs --------</a>
    <a href="deployment_log.html"><lord-icon src="https://cdn.lordicon.com/abwrkdvl.json" trigger="hover"></lord-icon>Deployment History Log</a>
    <a href="inventory_log.html"><lord-icon src="https://cdn.lordicon.com/hwuyodym.json" trigger="hover"></lord-icon>Inventory History Log</a>
    <a href="salary_logs.html"><lord-icon src="https://cdn.lordicon.com/qhgmphtg.json" trigger="hover"></lord-icon>Salary History Log</a>
    <a href="Reports.html"><lord-icon src="https://cdn.lordicon.com/wloilxuq.json" trigger="hover"></lord-icon>Report History Log</a>
  </div>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand ms-3 fw-bold" href="#">JAHS Telecon Employee Web Portal</a>
      <div class="dropdown ms-auto me-3">
        <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
          <lord-icon src="https://cdn.lordicon.com/ajkxzzfb.json" trigger="hover" style="width:28px;height:28px;margin-right:8px;"></lord-icon>
          <span id="welcome">Loading...</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="#" onclick="logout()">Log out</a></li>
        </ul>
      </div>
    </div>
  </nav>
  <!-- Main Content -->
  <div class="content">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="fw-bold text-primary">Deployment Reports</h3>
      <div>
        <button id="printBtn" class="btn btn-primary"><i class="bi bi-printer"></i> Print Selected</button>
      </div>
    </div>
    <input type="text" id="searchInput" placeholder="Search by team leader, location, or report...">
    <div class="form-check mb-2">
      <input class="form-check-input" type="checkbox" id="selectAllReports">
      <label class="form-check-label" for="selectAllReports">Select All Reports</label>
    </div>
    <div id="reportsContainer" class="mt-3">Loading reports...</div>
  </div>
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    // Logout
    function logout() {
      Swal.fire({
        title: 'Are you sure?',
        text: 'You will be logged out of the system.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, log out',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#2f3b8f',
        cancelButtonColor: '#d33'
      }).then(result => {
        if(result.isConfirmed){
          localStorage.clear();
          Swal.fire({
            title: 'Logged out!',
            text: 'Redirecting to welcome page...',
            icon: 'success',
            timer: 1500,
            showConfirmButton: false
          });
          setTimeout(()=>{ window.location.href="welcome_page.html"; },1500);
        }
      });
    }
    const userName = localStorage.getItem("userName") || "Guest";
    const role = localStorage.getItem("role") || "visitor";
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("welcome").innerHTML = `Welcome, ${userName} (${role})`;
    });
    const GEOAPIFY_API_KEY = "c31791c9aa7141aa9b3ce79b0a265c01";
    const firebaseConfig = {
      apiKey: "AIzaSyB1Gbmp2j2cTfnUmuWTjcL2ypauUpQn8Qc",
      authDomain: "jahsportal.firebaseapp.com",
      databaseURL: "https://jahsportal-default-rtdb.firebaseio.com",
      projectId: "jahsportal",
      storageBucket: "jahsportal.firebasestorage.app",
      messagingSenderId: "798312139932",
      appId: "1:798312139932:web:2f6654cdd82a23406ff159"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function createMap(containerId, lat, lng) {
      const map = new maplibregl.Map({
        container: containerId,
        style: `https://maps.geoapify.com/v1/styles/klokantech-basic/style.json?apiKey=${GEOAPIFY_API_KEY}`,
        center: [lng, lat],
        zoom: 17
      });
      new maplibregl.Marker({ color: "#3a4bbf" }).setLngLat([lng, lat]).addTo(map);
    }

    let allReports = {};
    function renderReports(filterText = "") {
      const container = document.getElementById("reportsContainer");
      const entries = Object.entries(allReports).sort((a, b) => new Date(b[1].reportCreatedAt) - new Date(a[1].reportCreatedAt));
      const filtered = entries.filter(([key, report]) => {
        const s = filterText.toLowerCase();
        return (report.teamLeader || "").toLowerCase().includes(s) ||
          (report.deploymentLocation || "").toLowerCase().includes(s) ||
          (report.report || "").toLowerCase().includes(s);
      });
      if(filtered.length === 0){
        container.innerHTML = "<p>No reports found.</p>";
        return;
      }
      container.innerHTML = "";
      filtered.forEach(([key, report], index) => {
        const div = document.createElement("div");
        div.className = "report selected"; // Default select all for print

        const createdAt = new Date(report.reportCreatedAt).toLocaleString();
        const teamLeader = report.teamLeader || "Unknown";
        const reportText = (report.report || "No report text.").replace(/\r?\n/g, "<br>");
        const lat = parseFloat(report.latitude);
        const lng = parseFloat(report.longitude);
        const mapId = `map-${index}`;
        const deploymentLocation = report.deploymentLocation || "Unknown location";
        const deploymentStart = report.deploymentStart ? new Date(report.deploymentStart).toLocaleDateString() : "-";
        const deploymentEnd = report.deploymentEnd ? new Date(report.deploymentEnd).toLocaleDateString() : "-";
        let imagesHtml = "";
        if (Array.isArray(report.images) && report.images.length > 0) {
          imagesHtml = "<div class='images'>";
          report.images.forEach(url => {
            if(url) imagesHtml += `<img src="${url}" alt="Report image" class="img-clickable" data-img="${url}"/>`;
          });
          imagesHtml += "</div>";
        }
        div.innerHTML = `
          <button class="delete-btn" data-id="${key}">Delete</button>
          <label class="select-label">
            <input type="checkbox" class="report-checkbox" checked />
            <span>Report ID: ${key}</span>
          </label>
          <p><strong>Created At:</strong> ${createdAt}</p>
          <p><strong>Team Leader:</strong> ${teamLeader}</p>
          <p><strong>Deployment Location:</strong> ${deploymentLocation}</p>
          <p><strong>Deployment Start:</strong> ${deploymentStart}</p>
          <p><strong>Deployment End:</strong> ${deploymentEnd}</p>
          <p><strong>Report:</strong><br>${reportText}</p>
          <p><br><strong>Site Survey:</strong><br></p>
          ${imagesHtml}
          <p><strong><br><br>Location:</strong><br></p>
          <div id="${mapId}" data-latitude="${lat}" data-longitude="${lng}" class="map"></div>
        `;
        container.appendChild(div);
        // Normal map for viewing
        if(!isNaN(lat) && !isNaN(lng)) {
          setTimeout(() => { createMap(mapId, lat, lng); }, 300);
        } else {
          const mapDiv = document.getElementById(mapId);
          if(mapDiv) mapDiv.textContent = "No location data available.";
        }
      });
      // --- Selection UI
      const selectAll = document.getElementById("selectAllReports");
      const checkboxes = container.querySelectorAll(".report-checkbox");
      checkboxes.forEach(cb => {
        cb.addEventListener("change", e => {
          const reportDiv = e.target.closest(".report");
          if (e.target.checked) {
            reportDiv.classList.add("selected");
          } else {
            reportDiv.classList.remove("selected");
          }
          const allChecked = Array.from(checkboxes).every(ch => ch.checked);
          selectAll.checked = allChecked;
        });
      });
      if (selectAll) {
        selectAll.onchange = function() {
          checkboxes.forEach(cb => {
            cb.checked = selectAll.checked;
            const reportDiv = cb.closest(".report");
            if (selectAll.checked) {
              reportDiv.classList.add("selected");
            } else {
              reportDiv.classList.remove("selected");
            }
          });
        };
      }
      // Delete buttons
      container.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", e => {
          const reportId = e.target.getAttribute("data-id");
          Swal.fire({
            title: 'Are you sure?',
            text: `Do you want to delete report ID: ${reportId}?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6'
          }).then(result => {
            if(result.isConfirmed){
              db.ref("deployment_reports/" + reportId).remove()
                .then(() => { Swal.fire('Deleted!', 'Report has been deleted.', 'success'); loadReports(); })
                .catch(err => { Swal.fire('Error', 'Failed to delete report: ' + err.message, 'error'); });
            }
          });
        });
      });
    }

    function loadReports() {
      const container = document.getElementById("reportsContainer");
      container.innerHTML = "<p>Loading reports...</p>";
      db.ref("deployment_reports").once("value")
        .then(snapshot => { allReports = snapshot.val() || {}; renderReports(); })
        .catch(error => { container.innerHTML = `<p style="color:red;">Error loading reports: ${error.message}</p>`; });
    }

    // -------- PRINTING WITH IMAGES AND STATIC MAP -------
    function getStaticMapUrl(lat, lng) {
      // Uses Geoapify Static Map API
      const apiKey = GEOAPIFY_API_KEY;
      return `https://maps.geoapify.com/v1/staticmap?style=osm-carto&width=500&height=250&center=lonlat:${lng},${lat}&zoom=17&marker=lonlat:${lng},${lat};color:%233a4bbf;size:medium&apiKey=${apiKey}`;
    }
    function printSelectedReports() {
      const reports = document.querySelectorAll(".report.selected");
      if(reports.length === 0){
        Swal.fire('No selection','Please select at least one report to print.','info'); 
        return;
      }
      Swal.fire({
        title: 'Printing Reports',
        text: 'Your browser print dialog will open.',
        icon: 'info',
        timer: 1200,
        showConfirmButton: false
      }).then(() => {
        const originalContents = document.body.innerHTML;
        let printContents = '<h1>Selected Deployment Reports</h1>';
        reports.forEach(r => {
          // Clone for manipulation
          let clone = r.cloneNode(true);
          // IMAGES: keep img src intact
          clone.querySelectorAll('.img-clickable').forEach(img => {
            img.setAttribute('style', 'max-width:140px;max-height:140px;border-radius:10px;margin:4px 8px 4px 0;display:inline-block;');
            img.classList.remove('img-clickable');
          });
          // STATIC MAP: replace .map with image
          let mapDiv = clone.querySelector('.map');
          if(mapDiv) {
            let lat = parseFloat(mapDiv.getAttribute('data-latitude')) || 0;
            let lng = parseFloat(mapDiv.getAttribute('data-longitude')) || 0;
            if(lat && lng) {
              const mapUrl = getStaticMapUrl(lat, lng);
              mapDiv.outerHTML = `<img src="${mapUrl}" style="width:100%;max-width:500px;margin-top:10px;border-radius:8px;">`;
            } else {
              mapDiv.outerHTML = `<span>No location data available.</span>`;
            }
          }
          // Remove controls/labels/checkbox/etc.
          clone.querySelectorAll('.delete-btn, .report-checkbox, .select-label').forEach(e => e && e.remove());
          printContents += "<div style='margin-bottom:40px;border-bottom:1px solid #ccc;padding-bottom:18px;'>" + clone.innerHTML + "</div>";
        });
        document.body.innerHTML = printContents;
        window.print();
        document.body.innerHTML = originalContents;
        window.location.reload();
      });
    }

    document.getElementById("searchInput").addEventListener("input", e => { renderReports(e.target.value); });
    document.getElementById("printBtn").addEventListener("click", printSelectedReports);
    window.onload = loadReports;
  </script>
</body>
</html>
