<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>My Leave Requests</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
    body {
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      margin: 0;
      background-image: url(infobg.png);
      background-size: cover;
      color: #111;
    }

  h2 {
    color: #2563eb;
    font-weight: 700;
    text-align: center;
    margin: 30px 0 20px;
    letter-spacing: 0.03em;
  }

  .wrap {
    max-width: 800px;
    margin: 0 auto 40px;
    padding: 0 20px;
  }

  #controls {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 20px;
    justify-content: space-between;
  }

  #searchBox {
    flex: 1 1 300px;
    padding: 10px 14px;
    font-size: 15px;
    border-radius: 6px;
    border: 1px solid #cbd5e1;
    box-sizing: border-box;
  }

  button {
    padding: 10px 18px;
    cursor: pointer;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    color: white;
    font-size: 15px;
    letter-spacing: 0.02em;
    transition: background-color 0.3s ease;
  }

  #deleteSelectedBtn {
    background-color: #dc2626;
  }
  #deleteSelectedBtn:hover {
    background-color: #b91c1c;
  }

  #backBtn {
    background-color: #6b7280;
    display: block;
    margin: 25px auto 0;
    width: 120px;
    text-align: center;
  }
  #backBtn:hover {
    background-color: #4b5563;
  }

  #leaveList {
    display: flex;
    flex-direction: column;
    gap: 18px;
  }

  .leave-card {
    background: white;
    border-left: 5px solid #2563eb;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: row;
    gap: 16px;
    align-items: flex-start;
    transition: transform 0.2s ease;
  }
  .leave-card:hover {
    transform: translateY(-3px);
  }

  .checkbox-container {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 4px;
  }
  .checkbox-container input[type="checkbox"] {
    transform: scale(1.3);
    cursor: pointer;
  }

  .card-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .card-header {
    font-weight: 700;
    font-size: 1.15em;
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: 10px;
    color: #1e293b;
  }

  .status {
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.85em;
    margin-left: auto;
    padding: 2px 8px;
    border-radius: 12px;
    color: white;
  }
  .approved {
    background-color: #16a34a;
  }
  .rejected {
    background-color: #dc2626;
  }
  .pending {
    background-color: #f59e0b;
  }

  .leave-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    font-size: 14px;
    font-weight: 600;
    color: #475569;
  }

  .reason {
    margin-top: 10px;
    font-style: italic;
    color: #64748b;
    font-weight: 400;
    font-size: 14px;
  }

  /* Responsive adjustments */
  @media (max-width: 600px) {
    .leave-card {
      flex-direction: column;
    }
    .checkbox-container {
      flex-direction: row;
      justify-content: flex-start;
      margin-bottom: 8px;
    }
  }
</style>
</head>
<body>
  <h2>My Leave Requests</h2>

  <div class="wrap">
    <div id="controls">
      <button id="backBtn" aria-label="Go back to previous page">Back</button>
      <input type="text" id="searchBox" placeholder="Search by Leave Type, Reason, or Status" aria-label="Search leave requests" />
      <button id="deleteSelectedBtn" aria-label="Delete selected leave requests">Delete Selected</button>
    </div>

    <div id="leaveList" role="list" aria-label="List of leave requests"></div>

  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB1Gbmp2j2cTfnUmuWTjcL2ypauUpQn8Qc",
      authDomain: "jahsportal.firebaseapp.com",
      databaseURL: "https://jahsportal-default-rtdb.firebaseio.com",
      projectId: "jahsportal",
      storageBucket: "jahsportal.firebasestorage.app",
      messagingSenderId: "798312139932",
      appId: "1:798312139932:web:2f6654cdd82a23406ff159"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const leaveList = document.getElementById('leaveList');
    const searchBox = document.getElementById('searchBox');
    const backBtn = document.getElementById('backBtn');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

    let requestsCache = [];

    function createRequestCard({ key, data }) {
      const card = document.createElement('article');
      card.className = 'leave-card';

      const checkboxContainer = document.createElement('div');
      checkboxContainer.className = 'checkbox-container';
      checkboxContainer.innerHTML = `<input type="checkbox" class="selectBox" data-key="${key}" aria-label="Select leave request for ${data.type}">`;
      card.appendChild(checkboxContainer);

      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';

      const header = document.createElement('div');
      header.className = 'card-header';
      header.textContent = data.type;

      const statusSpan = document.createElement('span');
      statusSpan.className = `status ${data.status.toLowerCase()}`;
      statusSpan.textContent = data.status;
      header.appendChild(statusSpan);

      cardContent.appendChild(header);

      const details = document.createElement('div');
      details.className = 'leave-info';
      details.innerHTML = `
        <div><strong>Start Date</strong><br>${data.startDate}</div>
        <div><strong>End Date</strong><br>${data.endDate}</div>
      `;
      cardContent.appendChild(details);

      const reasonDiv = document.createElement('div');
      reasonDiv.className = 'reason';
      reasonDiv.textContent = `Reason: ${data.reason}`;
      cardContent.appendChild(reasonDiv);

      card.appendChild(cardContent);

      return card;
    }

    function renderRequests(requests) {
      leaveList.innerHTML = '';
      if (requests.length === 0) {
        leaveList.innerHTML = '<p>No matching leave requests found.</p>';
        return;
      }
      requests.slice().reverse().forEach(req => {
        const card = createRequestCard(req);
        leaveList.appendChild(card);
      });
    }

    function loadRequests() {
      const loggedName = localStorage.getItem("userName") || localStorage.getItem("name");
      const loggedRole = localStorage.getItem("role");

      if (!loggedName || !loggedRole) {
        Swal.fire({
          icon: "warning",
          title: "Not logged in",
          text: "Please log in first.",
          confirmButtonColor: "#2563eb"
        }).then(() => window.location.href = "login.html");
        return;
      }

      db.ref('leaveRequests').orderByChild('name').equalTo(loggedName).once('value')
      .then(snapshot => {
        requestsCache = [];
        if (!snapshot.exists()) {
          leaveList.innerHTML = "<p>You have no leave requests.</p>";
          return;
        }
        snapshot.forEach(child => {
          requestsCache.push({ key: child.key, data: child.val() });
        });
        renderRequests(requestsCache);
      }).catch(err => leaveList.innerHTML = "<p>Error loading requests: " + err.message + "</p>");
    }

    function filterRequests() {
      const query = searchBox.value.trim().toLowerCase();
      if (!query) {
        renderRequests(requestsCache);
        return;
      }
      const filtered = requestsCache.filter(({data}) =>
        data.type.toLowerCase().includes(query) ||
        data.reason.toLowerCase().includes(query) ||
        data.status.toLowerCase().includes(query)
      );
      renderRequests(filtered);
    }

    searchBox.addEventListener('input', filterRequests);

    deleteSelectedBtn.addEventListener('click', () => {
      const selectedBoxes = Array.from(document.querySelectorAll('.selectBox:checked'));
      if (selectedBoxes.length === 0) {
        alert("Please select at least one leave request to delete.");
        return;
      }
      if (!confirm(`Delete ${selectedBoxes.length} selected leave request(s)? This action cannot be undone.`)) return;
      const deletes = selectedBoxes.map(box => db.ref("leaveRequests/" + box.dataset.key).remove());
      Promise.all(deletes)
        .then(() => {
          alert("Selected leave requests deleted successfully!");
          loadRequests();
        })
        .catch(err => alert("Error deleting requests: " + err.message));
    });

    backBtn.addEventListener('click', () => {
      if (window.history.length > 1) window.history.back();
      else window.location.href = "index.html";
    });

    window.onload = loadRequests;
  </script>
</body>
</html>
